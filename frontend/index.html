<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deck Registrierung</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="glass-card">
        <h1>
            {% if start_file_exists %}
                Deck Verteilung
            {% else %}
                Deck Registrierung
            {% endif %}
        </h1>

        <!-- Bedingte Anzeige basierend auf deck_id und start_file_exists -->
        {% if deck_id == 0 %}
            {% if start_file_exists %}
            <p class="status ok">
                Bitte scant jetzt noch mal die Decks, und verteilt Sie wie angegeben.
            </p>
            {% else %}
            <p class="status danger">
                Bitte warte, bis alle Decks registriert wurden.
            </p>
            {% endif %}
        {% elif existing_entry %}
        {% if start_file_exists %}
        <p class="status">
            Bitte übergebe dieses Deck an
            <span class="status ok" style="display:inline-block; padding:4px 8px; margin-left:6px;">
                {{ deckOwner }}
            </span>
        </p>
        {% else %}
        <p class="status danger">
            Dieses Deck wurde bereits registriert. Bitte warte bis der Raffle startet.
        </p>
        {% endif %}
        {% else %}
            <!-- Fehleranzeige -->
            {% if error %}
            <div class="status danger">
                {{ error }}
            </div>
            {% endif %}

            <!-- Formular -->
            <form action="/submit" method="post">
                <label for="deckersteller">Name des Deckerstellers:</label>
                <select id="deckersteller" name="deckersteller" required>
                    <option value="" disabled selected>Wählen Sie einen Namen</option>
                    {% for name in participants %}
                    <option value="{{ name }}" {% if values and values.get('deckersteller') == name %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
                <br><br>

                <label for="commander">Name des Commanders (Optional):</label>
                <div class="suggest-wrap">
                    <input type="text" id="commander" name="commander" class="commander-input" autocomplete="off"
                        value="{{ values.commander if values }}" placeholder="z.B. Akroma">
                    <div id="commanderSpinner" class="input-spinner"></div>
                    <div id="commanderSuggestBox" class="suggest-box"></div>
                </div>
                <br><br>


                <label for="deckUrl">DeckURL z.B. Moxfield (Optional):</label>
                <input type="url" id="deckUrl" name="deckUrl" value="{{ values.deckUrl if values }}">
                <br><br>

                <!-- Hidden Input für DeckID -->
                <input type="hidden" name="deck_id" value="{{ deck_id }}">

                <div class="btn-row">
                    <button type="reset">Reset</button>
                    <button type="submit">Send</button>
                </div>
            </form>
        {% endif %}

        <script>
            (() => {
            const MIN_CHARS = 3;
            const DEBOUNCE_MS = 350;

            const input = document.getElementById("commander");
            const box = document.getElementById("commanderSuggestBox");

            const spinner = document.getElementById("commanderSpinner");
            function setLoading(isLoading){
                if (!spinner) return;
                spinner.classList.toggle("show", !!isLoading);
            }

            function setBackground(url, zoom){
                if (url !== undefined && url !== null) {
                    document.documentElement.style.setProperty('--bg-image', `url("${url}")`);
                }
                if (zoom !== undefined && zoom !== null) {
                    document.documentElement.style.setProperty('--bg-zoom', String(zoom));
                }
            }

            async function loadDefaultBackground(){
                try{
                const r = await fetch("/api/background/default", { cache:"no-store" });
                if(!r.ok) return;
                const data = await r.json();
                if(data && data.url){
                    setBackground(data.url, data.zoom || 1.12);
                }
                }catch(_){}
            }

            async function loadCommanderBackground(name){
                try{
                const r = await fetch(`/api/background/commander?name=${encodeURIComponent(name)}`, { cache:"no-store" });
                if(!r.ok) return;
                const data = await r.json();
                if(data && data.url){
                    setBackground(data.url, data.zoom || 1.0);
                }
                }catch(_){}
            }

            // initial background: only if no commander preset
            document.addEventListener("DOMContentLoaded", () => {
                const current = (input?.value || "").trim();
                if (!current) loadDefaultBackground();
                else loadCommanderBackground(current);
            });

            // --- WebSocket live reload ("/" + "/?deck_id=...") ---
            const currentDeckId = Number("{{ deck_id }}") || 0;

            function wsUrl(params){
                const proto = (location.protocol === "https:") ? "wss" : "ws";
                return `${proto}://${location.host}/ws?${params}`;
            }

            function connectWS(){
                const params = (currentDeckId !== 0)
                    ? `deck_id=${encodeURIComponent(currentDeckId)}`
                    : "channel=home";

                const ws = new WebSocket(wsUrl(params));

                let pingTimer = null;

                ws.onmessage = (ev) => {
                    // Server sendet auch "pong" als Text -> nicht JSON.
                    if (ev.data === "pong") return;

                    let msg;
                    try{
                        msg = JSON.parse(ev.data);
                    }catch(_){
                        return; // ignorieren, wenn kein JSON
                    }

                    // "/" reload bei global changes
                    if(currentDeckId === 0 && msg.type === "state_changed" && msg.scope === "global"){
                        location.reload();
                        return;
                    }

                    // "/?deck_id=X" reload NUR, wenn diese ID betroffen ist
                    if(currentDeckId !== 0 && msg.type === "state_changed" && msg.scope === "deck" && msg.deck_id === currentDeckId){
                        location.reload();
                    }
                };

                ws.onopen = () => {
                    // Keepalive (manche Hosts schließen idle WS)
                    pingTimer = setInterval(() => {
                        if(ws.readyState === 1) ws.send("ping");
                    }, 25000);
                };

                ws.onclose = () => {
                    if (pingTimer) clearInterval(pingTimer);
                    setTimeout(connectWS, 1000);
                };

                ws.onerror = () => {
                    // optional: verhindert “stuck” sockets bei manchen Proxies
                    try { ws.close(); } catch(_) {}
                };
            }

            document.addEventListener("DOMContentLoaded", connectWS);

            if (!input || !box) return;

            let timer = null;
            let lastQuery = "";
            let inFlight = false;

            function hideBox(){
                box.style.display = "none";
                box.innerHTML = "";
            }

            function escapeHtml(s){
                return String(s)
                .replaceAll("&","&amp;")
                .replaceAll("<","&lt;")
                .replaceAll(">","&gt;")
                .replaceAll('"',"&quot;")
                .replaceAll("'","&#039;");
            }

            function render(names){
                if(!names || names.length === 0){
                hideBox();
                return;
                }
                box.innerHTML = names
                .map(n => `<div class="suggest-item" data-name="${escapeHtml(n)}">${escapeHtml(n)}</div>`)
                .join("");
                box.style.display = "block";
            }

            async function fetchSuggest(q){
            if(inFlight) return;
            inFlight = true;
            setLoading(true);
            try{
                const resp = await fetch(`/api/commander_suggest?q=${encodeURIComponent(q)}`, { cache:"no-store" });
                if(!resp.ok){ hideBox(); return; }
                const data = await resp.json();
                if(q !== lastQuery) return;
                render(data);
            }catch(_){
                hideBox();
            }finally{
                setLoading(false);
                inFlight = false;
            }
            }

            input.addEventListener("input", () => {
                const q = input.value.trim();
                lastQuery = q;

                // Wenn User das Feld leert: wieder default background
                if (q.length === 0) {
                    setLoading(false);
                    hideBox();
                    loadDefaultBackground();
                    return;
                }

                if(q.length < MIN_CHARS){
                    setLoading(false);
                    hideBox();
                    return;
                }

                clearTimeout(timer);
                timer = setTimeout(() => fetchSuggest(q), DEBOUNCE_MS);
            });

            box.addEventListener("click", (ev) => {
                const item = ev.target.closest(".suggest-item");
                if(!item) return;
                const name = item.getAttribute("data-name");
                input.value = name;
                hideBox();
                loadCommanderBackground(name);
            });

            document.addEventListener("click", (ev) => {
                if(ev.target === input || box.contains(ev.target)) return;
                hideBox();
            });

            input.addEventListener("keydown", (ev) => {
                if(ev.key === "Escape") hideBox();
            });
            })();
        </script>

    </div>
</body>
</html>
