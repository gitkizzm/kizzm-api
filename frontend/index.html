<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deck Registrierung</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    {% set show_card_preview = not (existing_entry and (existing_entry.pairing_round or existing_entry.pairing_phase == "voting")) %}
    <!-- 3D Card Preview (überlappt die glass-card leicht am oberen Rand) -->
    {% if show_card_preview %}
        <div id="cardPreview"
                class="card-preview is-single"
                aria-hidden="true"
                data-reveal="{% if start_file_exists and existing_entry and existing_entry.received_confirmed %}1{% else %}0{% endif %}"
                data-commander="{% if existing_entry and existing_entry.commander %}{{ existing_entry.commander }}{% endif %}"
                data-commander2="{% if existing_entry and existing_entry.commander2 %}{{ existing_entry.commander2 }}{% endif %}">
            <div class="card3d slot1" data-slot="1">
                <div class="card3d-face front"></div>
                <div class="card3d-face back"></div>
            </div>

            <div class="card3d slot2 is-placeholder is-hidden" data-slot="2">
                <div class="card3d-face front"></div>
                <div class="card3d-face back"></div>
            </div>
        </div>
    {% endif %}
        
    <div class="glass-card{% if show_card_preview %} has-card-preview{% endif %}" data-deck-id="{{ deck_id }}">

        <h1>{{ glasscard_title or "Deckregistrierung" }}</h1>

        <!-- Bedingte Anzeige basierend auf deck_id und start_file_exists -->
        {% if deck_id == 0 %}
            {% if start_file_exists %}
            <p class="status ok">
                Bitte scant jetzt noch mal die Decks, und verteilt Sie wie angegeben.
            </p>
            {% else %}
            <p class="status danger">
                Bitte warte, bis alle Decks registriert wurden.
            </p>
            {% endif %}
        {% elif existing_entry %}
        {% if start_file_exists %}
        {% if existing_entry.pairing_round and existing_entry.pairing_phase != "voting" %}
            <div class="status ok">
                Hallo {{ deckOwner }}.
            </div>
            <div class="status pairing-status" style="margin-top: 12px;">
                <div class="pairing-table-label">Tisch {{ existing_entry.pairing_table }}</div>
                <div class="pairing-matchup-grid" aria-label="Spieler-Matchup">
                    {% set players = existing_entry.pairing_players or [] %}
                    {% set slots = [
                        {'side': 'left', 'player': players[0] if players|length > 0 else ''},
                        {'side': 'right', 'player': players[1] if players|length > 1 else ''},
                        {'side': 'left', 'player': players[2] if players|length > 2 else ''},
                        {'side': 'right', 'player': players[3] if players|length > 3 else ''}
                    ] %}

                    {% for slot in slots %}
                    <div class="pairing-chip-slot {{ slot.side }}">
                        {% if slot.player %}
                        {% set content_align = 'right' if slot.side == 'left' else 'left' %}
                        <div
                            class="report-player-chip report-player-chip--matchup report-player-chip--content-{{ content_align }} is-static"
                            data-player="{{ slot.player }}"
                            title="{{ slot.player }}"
                            aria-label="{{ slot.player }}">
                            <div class="report-player-avatar">
                                <span class="report-player-avatar-fallback">{{ slot.player[:1]|upper }}</span>
                            </div>
                            <div class="report-player-name">{{ slot.player }}</div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}

                    <div class="pairing-vs-chip" aria-hidden="true">VS</div>
                </div>
            </div>
            <div class="btn-row" style="margin-top: 12px;">
                <button type="button" id="openReportModal">Ergebnis melden</button>
            </div>
        {% else %}
        <p class="status">
            Bitte übergebe dieses Deck an
            <span class="status ok" style="display:inline-block; padding:4px 8px; margin-left:6px;">
                {{ deckOwner }}
            </span>
        </p>

        {% if existing_entry.received_confirmed %}
            <div class="status ok" style="margin-top: 12px;">
                Erhalt des Decks wurde bestätigt.
            </div>
        {% else %}
            <form action="/confirm_received" method="post" style="margin-top: 14px;">
                <input type="hidden" name="deck_id" value="{{ deck_id }}">
                <div class="btn-row">
                    <button type="submit">
                        Erhalt bestätigen
                    </button>
                </div>
            </form>
        {% endif %}

        {% if existing_entry.pairing_phase == "voting" %}
            <div class="status danger" style="margin-top: 12px;">
                Spielphase beendet. Bitte jetzt das Voting starten.
            </div>
        {% elif start_file_exists and existing_entry.received_confirmed %}
            <div class="status" style="margin-top: 12px;">
                Bitte warte auf die Pairings.
            </div>
        {% endif %}
        {% endif %}

        {% else %}
        <p class="status danger">
            Dieses Deck wurde bereits registriert. Bitte warte bis der Raffle startet.
        </p>
        {% endif %}
        {% else %}
            <!-- Fehleranzeige -->
            {% if error %}
            <div class="status danger">
                {{ error }}
            </div>
            {% endif %}

            <!-- Formular -->
            <form action="/submit" method="post">
                <label for="deckersteller">Name des Deckerstellers:</label>
                <select id="deckersteller" name="deckersteller" required>
                    <option value="" disabled selected>Wählen Sie einen Namen</option>
                    {% for name in participants %}
                    <option value="{{ name }}" {% if values and values.get('deckersteller') == name %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
                

                <label for="commander">Name des Commanders:</label>
                <div class="suggest-wrap">
                    <input type="text" id="commander" name="commander" class="commander-input" autocomplete="off" required
                        value="{{ values.commander if values }}" placeholder="z.B. Akroma (sucht auf Scryfall)">
                    <input type="hidden" id="commander_id" name="commander_id" value="{{ values.commander_id if values }}">
                    <div id="commanderSpinner" class="input-spinner"></div>
                    <div id="commanderSuggestBox" class="suggest-box"></div>
                </div>
                {% if field_errors and field_errors.get('commander') %}
                <div class="field-error">{{ field_errors.get('commander') }}</div>
                {% endif %}
                

                <div id="commander2Wrap">
                    <div class="suggest-wrap">
                        <input type="text" id="commander2" name="commander2" class="commander-input" autocomplete="off"
                            value="{{ values.commander2 if values }}"
                            placeholder="Partner (freigeschaltet, wenn partnerfähiger Commander ausgewählt ist)"
                            disabled>
                        <input type="hidden" id="commander2_id" name="commander2_id" value="{{ values.commander2_id if values }}">
                        <div id="commander2Spinner" class="input-spinner"></div>
                        <div id="commander2SuggestBox" class="suggest-box"></div>
                    </div>
                    {% if field_errors and field_errors.get('commander2') %}
                    <div class="field-error">{{ field_errors.get('commander2') }}</div>
                    {% endif %}
                    <div id="commander2LiveError" class="field-error" style="display:none;"></div>
                    
                </div>


                <label for="deckUrl">DeckURL z.B. Moxfield (optional):</label>
                <input type="url" id="deckUrl" name="deckUrl" value="{{ values.deckUrl if values }}">
                

                <!-- Hidden Input für DeckID -->
                <input type="hidden" name="deck_id" value="{{ deck_id }}">

                <div class="btn-row">
                    <button type="reset">Reset</button>
                    <button type="submit" id="submitBtn">Send</button>
                </div>
            </form>
        {% endif %}

        <script src="/static/index.js" defer></script>

    </div>
    <div class="modal-overlay" id="reportModal" aria-hidden="true">
        <div class="modal report-modal" role="dialog" aria-modal="true" aria-labelledby="reportModalTitle">
            <h2 id="reportModalTitle">Ergebnis melden</h2>
            <div class="report-layout">
                <div class="report-box" id="reportPlayersPool"></div>
                <div class="report-box report-places" id="reportPlaces">
                    {% for place in [1,2,3,4] %}
                        <div class="report-place-slot" data-place="{{ place }}">
                            <div class="report-dropzone" data-place="{{ place }}" data-place-label="Platz {{ place }}"></div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            <p id="reportModalError" class="field-error" style="display:none;"></p>
            <div class="modal-actions">
                <button type="button" class="btn-ghost" id="cancelReport">Abbrechen</button>
                <button type="button" id="submitReport">Überschreiben</button>
            </div>
        </div>
    </div>

</body>
</html>
